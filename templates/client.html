// http://stackoverflow.com/questions/12232304/how-to-implement-server-push-in-flask-framework

{% extends "layout.html" %}
{% block body %}
<script type="text/javascript">
  function updateMovement(movement) {
    if (movement == "left") {
        document.getElementById("direction").src = "{{ url_for('static',filename='left.png') }}";
    } else if (movement == "forward") {
        document.getElementById("direction").src = "{{ url_for('static', filename='forward.png') }}";
    } else if (movement == "right") {
        document.getElementById("direction").src = "{{ url_for('static', filename='right.png') }}";
    } else if (movement == "backward") {
        document.getElementById("direction").src = "{{ url_for('static', filename='backward.png') }}";
    } else if (movement == "stoppend") {
        document.getElementById("direction").src = "{{ url_for('static', filename='stopped.png') }}";
  }


  $(function() {
    var source = new EventSource('/_movement');

    source.addEventListener('message', function(e) {
       var data = JSON.parse(e.data);
       updateMovement(data.movement)});

      var submitCommand = function(e) {
      keynum = e.keyCode;

      if (keynum == 37) { // left
        command = 'left'
        updateMovement(command)
      } else if (keynum == 38) { // up
        command = 'forward'
        updateMovement(command)
      } else if (keynum == 39) { //right
        command = 'right'
        updateMovement(command)
      } else if (keynum == 40) { //down
        command = 'backward'
        updateMovement(command)
      }

      $.getJSON($SCRIPT_ROOT + '_drive', {
        direction: command
      }, function(data) {
        $('#result').text(data.result);
      });
  
    return false;
    };

    $('body').bind('keydown', submitCommand);
  }).ready();
    
</script>
<span id="result"></span>
<img id="direction" src="{{ url_for('static', filename='stopped.png') }}"><img>
{% endblock %}
